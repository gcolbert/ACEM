<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE urlrewrite PUBLIC "-//tuckey.org//DTD UrlRewrite 3.2//EN"
        "http://www.tuckey.org/res/dtd/urlrewrite3.2.dtd">

<!--

    Configuration file for UrlRewriteFilter
    http://tuckey.org/urlrewrite/

-->
<urlrewrite use-query-string="true" decode-using="UTF-8">

	<rule>
		<note>Cette règle force le mode HTTPS</note>
	    <condition type="scheme" operator="notequal">https</condition>
	    <condition name="host" operator="equal">old.project.fr</condition>
	    <from>^/(.*)</from>
	    <to type="permanent-redirect" last="true">https://old.project.fr/$1</to>
	</rule>
 
 
	<outbound-rule encodefirst="true">
		<name>Strip URL Session ID's</name>
		<note>Cette règle supprime les "jsessionid" des URLs générées (qui fait planter les réécritures d'URLs)</note>
		<from>^(.*?)(?:\;jsessionid=[^\?#]*)?(\?[^#]*)?(#.*)?$</from>
		<to>$1$2$3</to>
	</outbound-rule>


	<rule>
	    <condition name="user-agent" operator="notequal">iPhone</condition>
        <condition name="user-agent" operator="notequal">iPad</condition>
        <condition name="user-agent" operator="notequal">Android</condition>
	    <from>^/catalogue/([\-0-9a-fA-F]+){1}/([\-0-9a-fA-F]+){1}$</from>
	    <to>/pc/catalog.jsp?selectedCategoryId=$1&amp;selectedSubCategoryId=$2</to>
	</rule>

	<rule>
	    <from>^/catalogue/([\-0-9a-fA-F]+){1}/([\-0-9a-fA-F]+){1}$</from>
	    <to>/catalog.jsp?selectedCategoryId=$1&amp;selectedSubCategoryId=$2</to>
	</rule>

	<rule>
	    <condition name="user-agent" operator="notequal">iPhone</condition>
        <condition name="user-agent" operator="notequal">iPad</condition>
        <condition name="user-agent" operator="notequal">Android</condition>
	    <from>^/catalogue/([\-0-9a-fA-F]+)$</from>
	    <to>/pc/catalog.jsp?selectedCategoryId=$1</to>
	</rule>

	<rule>
	    <from>^/catalogue/([\-0-9a-fA-F]+)$</from>
	    <to>/catalog.jsp?selectedCategoryId=$1</to>
	</rule>

	<rule>
	    <condition name="user-agent" operator="notequal">iPhone</condition>
        <condition name="user-agent" operator="notequal">iPad</condition>
        <condition name="user-agent" operator="notequal">Android</condition>
	    <from>^/catalogue/{0,1}$</from>
	    <to>/pc/catalog.jsp</to>
	</rule>

	<rule>
	    <from>^/catalogue/{0,1}$</from>
	    <to>/catalog.jsp</to>
	</rule>


	<rule>
	    <condition name="user-agent" operator="notequal">iPhone</condition>
        <condition name="user-agent" operator="notequal">iPad</condition>
        <condition name="user-agent" operator="notequal">Android</condition>
	    <from>^/fiche/([\-0-9a-fA-F]+){1}$</from>
	    <to>/pc/issue.jsp?selectedIssueId=$1</to>
	</rule>

	<rule>
	    <condition name="user-agent" operator="notequal">iPhone</condition>
        <condition name="user-agent" operator="notequal">iPad</condition>
        <condition name="user-agent" operator="notequal">Android</condition>
	    <from>^/fiche/([\-0-9a-fA-F]+){1}/([0-9]+)$</from>
	    <to>/pc/issue.jsp?selectedIssueId=$1&amp;page=$2</to>
	</rule>
	
	<rule>
	    <from>^/fiche/([\-0-9a-fA-F]+){1}$</from>
	    <to>/issue.jsp?selectedIssueId=$1</to>
	</rule>


	<rule>
	    <from>^/version/([\-0-9a-fA-F]+){1}$</from>
	    <to>/version.jsp?selectedVersionId=$1</to>
	</rule>


	<rule match-type="regex">
	    <condition name="user-agent" operator="notequal">iPhone</condition>
        <condition name="user-agent" operator="notequal">iPad</condition>
        <condition name="user-agent" operator="notequal">Android</condition>
		<from>^/recherche\?item=([%\+\-0-9a-zA-Z;]+)$</from>
		<to>/pc/search.jsp?item=$1</to>
	</rule>

	<rule match-type="regex">
		<from>^/recherche\?item=([%\+\-0-9a-zA-Z;]+)$</from>
		<to>/search.jsp?item=$1</to>
	</rule>


	<rule>
	    <from>^/compte/{0,1}$</from>
	    <to>/account.jsp</to>
	</rule>


	<rule>
	    <condition name="user-agent" operator="notequal">iPhone</condition>
        <condition name="user-agent" operator="notequal">iPad</condition>
        <condition name="user-agent" operator="notequal">Android</condition>
	    <from>^/confirm/([\-0-9a-fA-F]+){1}$</from>
	    <to>/pc/confirm.jsp?selectedIssueId=$1</to>
	</rule>


	<rule>
	    <condition name="user-agent" operator="notequal">iPhone</condition>
        <condition name="user-agent" operator="notequal">iPad</condition>
        <condition name="user-agent" operator="notequal">Android</condition>
		<condition type="method">GET</condition>
	    <from>^/achats/([\-0-9a-fA-F]+){1}$</from>
	    <to>/pc/buys.jsp?memberId=$1</to>
	</rule>

	<rule>
		<condition type="method">GET</condition>
	    <from>^/achats/([\-0-9a-fA-F]+){1}$</from>
	    <to>/buys.jsp?memberId=$1</to>
	</rule>

	<rule>
		<note>Requête permettant à un client d'acheter une Issue</note>
		<condition type="method">POST</condition>
		<from>^/achats/([\-0-9a-fA-F]+){1}$</from>
		<set type="request" name="memberId">$1</set>
		<run class="com.sfr.kiosque.servlets.BuyServlet" method="doPost"/>
		<to>null</to>
	</rule>


	<rule>
	    <condition name="user-agent" operator="notequal">iPhone</condition>
        <condition name="user-agent" operator="notequal">iPad</condition>
        <condition name="user-agent" operator="notequal">Android</condition>
		<condition type="method">GET</condition>
	    <from>^/abonnements/([\-0-9a-fA-F]+){1}$</from>
	    <to>/pc/subscriptions.jsp?memberId=$1</to>
	</rule>

	<rule>
		<condition type="method">GET</condition>
	    <from>^/abonnements/([\-0-9a-fA-F]+){1}$</from>
	    <to>/subscriptions.jsp?memberId=$1</to>
	</rule>

	<rule>
		<note>Requête permettant à un client de s'abonner à une Version</note>
		<condition type="method">POST</condition>
		<from>^/abonnements/([\-0-9a-fA-F]+){1}$</from>
		<set type="request" name="memberId">$1</set>
		<run class="com.sfr.kiosque.servlets.SubscribeServlet" method="doPost"/>
		<to>null</to>
	</rule>


	<rule>
	    <condition name="user-agent" operator="notequal">iPhone</condition>
        <condition name="user-agent" operator="notequal">iPad</condition>
        <condition name="user-agent" operator="notequal">Android</condition>
	    <from>^/deconnexion$</from>
	    <to>/pc/identification.jsp?disconnect=true</to>
	</rule>
 
	<rule>
	    <from>^/deconnexion$</from>
	    <to>/identification.jsp?disconnect=true</to>
	</rule>


	<rule>
	    <condition name="user-agent" operator="notequal">iPhone</condition>
        <condition name="user-agent" operator="notequal">iPad</condition>
        <condition name="user-agent" operator="notequal">Android</condition>
	    <from>^/identification(\?cookiesAreBlocked=true)?$</from>
	    <to>/pc/identification.jsp$1</to>
	</rule>

	<rule>
	    <from>^/identification(\?cookiesAreBlocked=true)?$</from>
	    <to>/identification.jsp$1</to>
	</rule>
 
 
	<rule>
	    <condition name="user-agent" operator="notequal">iPhone</condition>
        <condition name="user-agent" operator="notequal">iPad</condition>
        <condition name="user-agent" operator="notequal">Android</condition>
	    <from>^/guide-utilisateur$</from>
	    <to>/pc/guide-utilisateur.jsp</to>
	</rule>
	
	
	<rule>
	    <from>^/guide-utilisateur$</from>
	    <to>/guide-utilisateur.jsp</to>
	</rule>
 
 
	<rule>
	    <condition name="user-agent" operator="notequal">iPhone</condition>
        <condition name="user-agent" operator="notequal">iPad</condition>
        <condition name="user-agent" operator="notequal">Android</condition>
	    <from>^/cgu$</from>
	    <to>/pc/cgu.jsp</to>
	</rule>

	<rule>
	    <from>^/cgu$</from>
	    <to>/cgu.jsp</to>
	</rule>


	<rule>
		<note>Point d'accès à la boutique en mode authentifié pour l'application Android : Msisdn/Password</note>
		<condition type="method">GET</condition>
		<from>^/webview/([0-9]{10}):(.*)$</from>
		<set type="request" name="userName">$1</set>
		<set type="request" name="userPassword">$2</set>
		<run class="com.old.kiosque.servlets.WebViewServlet" method="doGet"/>
		<to>null</to>
	</rule>

	<rule>
		<note>Point d'accès à la boutique en mode authentifié pour l'application Android : Email/Password</note>
		<condition type="method">GET</condition>
		<from>^/webview/(\b[A-Z0-9._%-]+@[A-Z0-9.-]+\.[A-Z]{2,4}\b):(.*)$</from>
		<set type="request" name="userName">$1</set>
		<set type="request" name="userPassword">$2</set>
		<run class="com.old.kiosque.servlets.WebViewServlet" method="doGet"/>
		<to>null</to>
	</rule>

    <!--

    INSTALLATION

        in your web.xml add...

        <filter>
            <filter-name>UrlRewriteFilter</filter-name>
            <filter-class>org.tuckey.web.filters.urlrewrite.UrlRewriteFilter</filter-class>
            <init-param>
                <param-name>logLevel</param-name>
                <param-value>WARN</param-value>
            </init-param>
        </filter>
        <filter-mapping>
            <filter-name>UrlRewriteFilter</filter-name>
            <url-pattern>/*</url-pattern>
        </filter-mapping>

     EXAMPLES

     Redirect one url
        <rule>
            <from>/some/old/page.html</from>
            <to type="redirect">/very/new/page.html</to>
        </rule>

    Redirect a directory
        <rule>
            <from>/some/olddir/(.*)</from>
            <to type="redirect">/very/newdir/$1</to>
        </rule>

    Clean a url
        <rule>
            <from>/products/([0-9]+)</from>
            <to>/products/index.jsp?product_id=$1</to>
        </rule>
    eg, /products/1234 will be passed on to /products/index.jsp?product_id=1234 without the user noticing.

    Browser detection
        <rule>
            <condition name="user-agent">Mozilla/[1-4]</condition>
            <from>/some/page.html</from>
            <to>/some/page-for-old-browsers.html</to>
        </rule>
    eg, will pass the request for /some/page.html on to /some/page-for-old-browsers.html only for older
    browsers whose user agent srtings match Mozilla/1, Mozilla/2, Mozilla/3 or Mozilla/4.

    Centralised browser detection
        <rule>
            <condition name="user-agent">Mozilla/[1-4]</condition>
            <set type="request" name="browser">moz</set>
        </rule>
    eg, all requests will be checked against the condition and if matched
    request.setAttribute("browser", "moz") will be called.

    -->

</urlrewrite>
